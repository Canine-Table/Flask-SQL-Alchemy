{% extends '_base.html' %}
{% block title %}Market{% endblock %}
{% block content %}
    <div class="container-xxl jumbotron p-2 ml-4 mr-4 text-center jbtron">
        <div class="jumbotron fgc p-3 mt-3">
            <h1>Hello {{ current_user.username }}, welcome to the Flask Marketplace.</h1>
        </div>
        {{ errors() }}
    </div>
    <div class="jumbotron container-xxl p-2 ml-4 mr-4 jbtron">
        <div class="col">
            <div class="jumbotron fgc p-3 mt-3">
                <h2>Owned Items</h2>
                <p>Click on sell item to put the item back on the Market</p><br>
            </div>
            <div class="row">
                {% for owned_item in owned_items %}
                    <div class="col-md-4" >
                        <div class="card text-center mb-4 bkg">
                            <div class="card-body my_content">
                                <h5 class="card-title">{{ owned_item.item_purchase.name }}</h5>
                                {% macro sell_modal_body() %}
                                    <form method="POST">
                                        <p class="text-left">Are you sure you want to sell your <b>{{ owned_item.item_purchase.name }}</b> for <b>${{ owned_item.item_purchase.price }}</b>?</p>
                                        <input type="number" id="sold_item_count-{{ owned_item.id }}" name="sell_count" min="1" max="{{ owned_item.count }}">
                                {% endmacro %}
                                {% macro sell_modal_footer() %}
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                        {{ sell_form.hidden_tag() }}
                                        <input id="form_name-{{ owned_item.id }}" name="form_name" type="hidden" value="sold_form">
                                        <input id="sold_item-{{ owned_item.id }}" name="sold_item" type="hidden" value='{{ {"id":owned_item.item_purchase.id,"name":owned_item.item_purchase.name,"price":owned_item.item_purchase.price,"barcode":owned_item.barcode,"description":owned_item.item_purchase.description,"stock":owned_item.count,"count":owned_item.owner} | tojson }}'>
                                        {{ sell_form.submit(class="btn btn-danger") }}
                                    </form>
                                {% endmacro %}
                                {% set mid = env.globals['secrets'].token_hex(12)|upper %}
                                <button type="button" class="btn btn-outline btn-danger" style="margin-bottom: 5px" data-toggle="modal" data-target="#Modal-{{ mid }}">Sell {{ owned_item.item_purchase.name }}</button>
                                <p class="card-text"><strong>This item costs ${{ owned_item.item_purchase.price }}</strong></p>
                                {{ modal(
                                    modal_id=mid,
                                    button_id=mid,
                                    modal_title=owned_item.item_purchase.name,
                                    modal_header=True,
                                    modal_body=True,
                                    modal_footer=True,
                                    body=sell_modal_body(),
                                    body_classes='text-left',
                                    footer=sell_modal_footer(),
                                    in_button=False,
                                    keep_close=False
                                ) }}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="jumbotron p-0 container-xxl bgc">
        <div class="jumbotron p-2 ml-4 mr-4 jbtron">
            <div class="jumbotron fgc p-3 mt-3">
                <h2>Available Items on the Market</h2>
                <p>Click on one of the items to start buying</p>
            </div>
            <table class="table table-hover table-bordered table-dark">
                <thead>
                    <tr>
                        <th scope="col">ID</th>
                        <th scope="col">Name</th>
                        <th scope="col">Options</th>
                    </tr>
                </thead>
                <tbody>
                    {% for purchased_item in purchased_items %}
                        <tr>
                            <td>{{ purchased_item.name }}</td>
                            <td>${{ purchased_item.price }}</td>
                            <td>
                                <a class="btn btn-primary" href="{{ url_for('market.comments_page',item=purchased_item.barcode) }}">Comment</a>
                                {% macro info_body() %}
                                    <p><b>Item ID:</b> {{ purchased_item.id }}</p>
                                    <p><b>Price:</b> ${{ purchased_item.price }}</p>
                                    <p><b>Barcode:</b> {{ purchased_item.barcode }}</p>
                                    <p><b>Description:</b> {{ purchased_item.description }}</p>
                                {% endmacro %}
                                {{ modal(
                                    modal_id=env.globals['secrets'].token_hex(12)|upper,
                                    button_classes='btn-outline btn-info',
                                    button_text='More Info',
                                    modal_header=True,
                                    modal_body=True,
                                    modal_footer=True,
                                    modal_title=purchased_item.name,
                                    body=info_body(),
                                ) }}
                                {% macro purchase_body() %}
                                    <form method="POST">
                                        {{ purchase_form.hidden_tag() }}
                                        <p>Are you sure you want to buy a <b>{{ purchased_item.name }}</b> for <b>${{ purchased_item.price }}</b>?</p>
                                        <input type="number" id="purchase_item_count-{{ purchased_item.id }}" name="purchase_count" min="1" max="{{ purchased_item.stock }}">
                                {% endmacro %}
                                {% macro purchase_footer() %}
                                        <input id="purchase_form_name-{{ purchased_item.id }}" name="form_name" type="hidden" value="purchase_form">
                                        <input id="unowned_item-{{ purchased_item.id }}" name="unowned_item" type="hidden" value='{{ {"id":purchased_item.id,"name":purchased_item.name,"price":purchased_item.price,"barcode":purchased_item.barcode,"description":purchased_item.description,"stock":purchased_item.stock} | tojson }}'>
                                        {{ purchase_form.submit(class="btn btn-primary") }}
                                    </form>
                                {% endmacro %}
                                    {{ modal(
                                        modal_id=env.globals['secrets'].token_hex(12)|upper,
                                        button_classes='btn-outline btn-success',
                                        button_text='Purchase',
                                        modal_header=True,
                                        modal_body=True,
                                        modal_footer=True,
                                        modal_title=purchased_item.name,
                                        body=purchase_body(),
                                        footer=purchase_footer()
                                    ) }}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}
